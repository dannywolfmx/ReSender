<link rel="import" href="./lista-compras.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<dom-module id="panel-compras">
    <template>
        <style>
            :host {
                display: block;
                overflow: overlay;
                max-height: calc(100vh - 44px);
            }



            #formulario {
                @apply --layout-horizontal;
                width: 100%;
            }

            #formulario>* {
                width: 100%;
                margin: 16px;
            }

            #contenedorLista {
                overflow: auto;
            }

            @media(max-width: 799px) {

                .listaCompras {
                    @apply --shadow-elevation-2dp;
                    margin: 12px;
                }
            }
        </style>

        <firebase-query app-name="bla" id="listaProveedores" path="/proveedores" data="{{proveedores}}" order-by-child="key"></firebase-query>

        <app-drawer-layout id="drawerLayout">

            <app-drawer id="drawer" slot="drawer" swipe-open>
                <div class="drawer-content">
                    <paper-listbox id="menu">
                        <template is="dom-repeat" items="{{proveedores}}">
                            <paper-item on-click="seleccionarProveedor">
                                    {{item.articulos.length}} | {{item.nombre}} 
                            </paper-item>

                        </template>
                    </paper-listbox>
                </div>
            </app-drawer>

            <app-header-layout>
                <app-header effects="waterfall" slot="header" reveals>
                    <dv-toolbar usuario-activo="[[usuarioActivo]]" cargando-pagina="[[cargandoPagina]]" mostrar-menu={{mostrarMenu}}></dv-toolbar>
                </app-header>

                <vaadin-text-field id="proveedorInput" label="Proveedor"></vaadin-text-field>

                <paper-button on-click="agregarProveedor" raised> Agregar proveedor</paper-button>

                <template id="contenedorLista" is="dom-repeat" items="{{proveedores}}" as="proveedor" filter="esProveedorSeleccionado" observe="[[proveedorSelected]]">
    
                <lista-compras class="listaCompras" titulo="[[proveedor.nombre]]" articulos="{{proveedor.articulos}}"></lista-compras>
                </template>
            </app-header-layout>

        </app-drawer-layout>


    </template>

    <script>
        /**
         * `panel-compras` Description
         *
         * @summary ShortDescription.
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
        class PanelCompras extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'panel-compras';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    proveedores: {
                        type: Array,
                        value: [],
                        observer: "prueba"
                    },
                    proveedorSelected:{
                        type:String,
                        value:"",
                        notify:true
                    }
                };
            }

            /**
             * Instance of the element is created/upgraded. Use: initializing state,
             * set up event listeners, create shadow dom.
             * @constructor
             */
            prueba(e) {
                console.log(e)
            }

            constructor() {
                super();
            }

            /**
             * Use for one-time configuration of your component after local DOM is initialized. 
             */
            ready() {
                super.ready();

                Polymer.RenderStatus.afterNextRender(this, function () {

                });
            }

            mostrarCompra(compraCompleta, controlMostrar) {
                //Determinar si muestro o no el elemento
                return true
            }

            //Agregar nuevo proveedor a firebase
            agregarProveedor() {
                //Detectamos el nombre del proveedor
                var nombreProveedor = this.$.proveedorInput.value.toUpperCase();

                if (nombreProveedor.length < 1) {
                    //Error el nombre no debe estar vacio
                    return -1
                }
                //Crear un filtro para detectar si el proveedor existe
                var buscaRepetido = (x) => x.nombre === nombreProveedor;
                //Pasamos el filtro a la lista y nos devuelve la coincidencia 
                var yaExisteProveedor = this.proveedores.find(buscaRepetido);
                //Aceptamos solo los elementos que no han sido insertados antes en la lista
                if (!yaExisteProveedor) {
                    //Llamar a la referencia de firebase
                    this.$.listaProveedores.ref.push({
                        //Colocar el nombre del proveedor
                        "nombre": this.$.proveedorInput.value
                    })
                }
                //Limpiar formulario
                this.$.proveedorInput.value = ""
            }

            abrirMenu() {
                this.$.drawer.toggle()
            }

            cambioArrayProveedro(e) {
                console.log(e)
            }

            seleccionarProveedor(e){
                this.set("proveedorSelected",e.model.item.nombre)
                this.$.contenedorLista.render()
            }

            esProveedorSeleccionado(e){
                return e.nombre === this.proveedorSelected
            }
        }

        window.customElements.define(PanelCompras.is, PanelCompras);
    </script>
</dom-module>