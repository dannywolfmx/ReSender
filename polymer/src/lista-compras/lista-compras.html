<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">


<dom-module id="lista-compras">
    <template>
        <style include="app-grid-style">
            :host {
                display: block;
                --app-grid-columns: 6;
                --app-grid-item-height: 100px;
                --app-grid-expandible-item-columns: 2;
            }

            .column {
                font-size: var(--lumo-font-size-m);
                padding: var(--lumo-space-xs) var(--lumo-space-m);
                font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                line-height: var(--lumo-line-height-s);
                color: #212121;
                font-weight: bold;
            }

            .estatus {
                color: var(--paper-grey-900);
                text-align: center;
                padding: 12px;
                font-size: 12px;
                width: 32px;
            }

            .top {
                @apply --layout-horizontal;
                @apply --layout-center;
                padding: 12px;
                border-bottom: 1px solid var(--paper-grey-300)
            }

            #nombre {
                width: 100%;
            }

            .cantidad {
                font-size: 16px;
                font-weight: bold;
            }

            .precio {
                min-width: 128px;
            }

            h1 {
                font-family: Roboto;
                margin-left: 24px;
            }

            @media(max-width: 799px) {
                :host {
                    --app-grid-columns: 2;
                    --app-grid-gutter: 5px;
                    --app-grid-item-height: 100px;
                    --app-grid-expandible-item-columns: 2;
                }

                .nombre{
                    background: black;
                    @apply --app-grid-expandible-item;  
                }
            }
        </style>

        <h1>[[titulo]] | TOTAL: ${{total}}</h1>
        <div id="formulario" class="top">
            <vaadin-text-field id="cantidad" class="column estatus" label="Cantidad"></vaadin-text-field>
            <vaadin-text-field id="nombre" class="column flex" label="Articulo"></vaadin-text-field>
            <paper-button on-click="agregarItem" class="column estatus" raised>Agregar articulo</paper-button>
        </div>
        <template is="dom-repeat" items="{{articulos}}" as="articulo" filter="noMostrarRecolectados">
            <div class="top app-grid">
                <div class="column estatus cantidad">( [[articulo.cantidad]] )</div>
                <div class="column flex nombre">[[articulo.nombre]]</div>
                <div>
                    <vaadin-text-field class="precio column estatus" label="Precio" value="{{articulo.precio}}"></vaadin-text-field>
                </div>
                <div>
                    Disponible:
                    <paper-toggle-button checked="{{articulo.sePuedaRecolectar}}"></paper-toggle-button>
                </div>
                <div>
                    Pagado:
                    <paper-toggle-button checked="{{articulo.pagado}}"></paper-toggle-button>
                </div>
                <div>
                    Recolectado:
                    <paper-toggle-button checked="{{articulo.recolectado}}"></paper-toggle-button>
                </div>
            </div>
        </template>

        <iron-media-query query="min-width: 600px" query-matches="{{wideLayout}}"></iron-media-query>

    </template>

    <script>
        /**
         * `lista-compras` Description
         *
         * @summary ShortDescription.
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
        class ListaCompras extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'lista-compras';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    articulos: {
                        type: Array,
                        notify: true,
                        observer: "sumaTotal"
                    },
                    total: {
                        type: Number,
                        value: 0
                    },
                    titulo: {
                        type: String
                    }
                };
            }

            /**
             * Instance of the element is created/upgraded. Use: initializing state,
             * set up event listeners, create shadow dom.
             * @constructor
             */
            constructor() {
                super();
            }

            /**
             * Use for one-time configuration of your component after local DOM is initialized. 
             */
            ready() {
                super.ready();

                Polymer.RenderStatus.afterNextRender(this, function () {

                });
            }
            sumaTotal(e) {
                var total = 0;
                var subTotal = 0;
                var iva = 1.16

                var funSubTotal = (articulo) => {
                    if (articulo.pagado) {
                        return 0
                    }
                    if (articulo.precio && articulo.cantidad && articulo.sePuedaRecolectar) {
                        return parseFloat(articulo.precio) * parseInt(articulo.cantidad)
                    } else {
                        return 0
                    }
                }


                if (Array.isArray(e)) {
                    var precios = e.map(funSubTotal)
                    subTotal = precios.reduce((a, b) => a + b)
                } else {
                    subTotal = funSubTotal(e);
                }

                total = subTotal * iva
                this.set("total", total.toFixed(2))
            }

            agregarItem() {
                if (this.articulos) {
                    this.push("articulos", {
                        cantidad: this.$.cantidad.value,
                        nombre: this.$.nombre.value
                    })
                } else {
                    this.inicializaArticulos()
                }
                this.limpiarCamposInput()
            }

            inicializaArticulos() {
                this.set("articulos", {
                    0: {
                        cantidad: this.$.cantidad.value,
                        nombre: this.$.nombre.value
                    }
                })
            }

            limpiarCamposInput() {
                this.$.cantidad.value = ""
                this.$.nombre.value = ""
            }

            noMostrarRecolectados(e) {
                return !e.recolectado
            }

        }

        window.customElements.define(ListaCompras.is, ListaCompras);
    </script>
</dom-module>