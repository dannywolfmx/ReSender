<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/timeu-wizard/timeu-wizard.html">

<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">


<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-password-field.html">



<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">



<link rel="import" href="../../bower_components/vaadin-tabs/vaadin-tabs.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">




<!-- Customs elements -->

<link rel="import" href="../orden/lista-ordenes.html">
<link rel="import" href="../orden/orden-de-compra.html">

<link rel="import" href="../lista-compras/lista-compras.html">

<link rel="import" href="../configuracion-correo/configuracion-correo.html">

<dom-module id="polymer-app">
  <template>
    <style is="custom-style">
      :host {
        display: block;
      }

      paper-fab {
        position: fixed;
        right: 25px;
        bottom: 30px;
      }
    </style>

    <firebase-app name="bla" auth-domain="resender-b91e7.firebaseapp.com" database-url="https://resender-b91e7.firebaseio.com"
      api-key="AIzaSyCtLZ9t6H1W7K2c39gYn5X08aj7bnvLhT4" storage-bucket="resender-b91e7.appspot.com" messaging-sender-id="311497558478">
    </firebase-app>

    <firebase-document app-name="bla" id="configuarionCorreoQuery" path="/configuarionCorreo" data="{{configuarionCorreo}}"></firebase-document>
    <firebase-query app-name="bla" id="query" path="/ordenes" data="{{listaOrdenes}}" order-by-child="key"></firebase-query>


    <vaadin-tabs selected="{{pagina}}">
      <vaadin-tab>Lista de ordenes</vaadin-tab>
      <vaadin-tab>Lista de compras ( {{cantidadCompras}} )</vaadin-tab>
      <vaadin-tab>Configuracion</vaadin-tab>
    </vaadin-tabs>

    <iron-pages selected="[[pagina]]">
      <section>
        <paper-fab on-tap="agregarNuevaOrdenDeCompra" icon="add"></paper-fab>
        <lista-ordenes ordenes="[[listaOrdenes]]" llave-orden={{llaveOrden}} configuarion-correo=[[configuarionCorreo]]></lista-ordenes>
      </section>
      <lista-compras compras="[[compras]]"></lista-compras>

      <configuracion-correo configuarion-correo="{{configuarionCorreo}}"></configuracion-correo>

    </iron-pages>

  </template>
  <script>
    /**
     * @customElement
     * @polymer
     */
    class PolymerApp extends Polymer.Element {
      static get is() {
        return 'polymer-app';
      }

      ready() {
        super.ready()
      }
      static get properties() {
        return {
          listaOrdenes: {
            type: Array,
            value: [],
            observer: "generarCompras"
          },
          compras: {
            type: Array
          },
          cantidadCompras: {
            type: Number,
            value: 0
          }
        };
      }

      agregarNuevaOrdenDeCompra() {
        let a = this.$.query.ref.push({
          "ordenDeCompra": "",
          "listaCorreos": {
            0: ""
          },
          "productos": {
            0: ""
          }
        })
      }

      /*
              proveedor:{
                nombre:proveedor
                articulos:{
                  nombre,
                  cliente,
                  oc
                }
            } */


      generarCompras(ordenes) {
        let compras = []
        ordenes.map(orden => {
          if (orden.productos) {
            orden.productos.map(producto => {
              //Verificar que producto sea un objeto
              if(!(typeof producto == 'object')) return -1
              //Verificamos que este producto tenga un proveedor
              if (!producto.proveedor || producto.proveedor.length < 0) producto.proveedor = "Proveedor sin definir"

              //Verifica si el proveedor ya esta en la lista
              let posicion = compras.findIndex(x => x.nombre === producto.proveedor)

              //Inicializa un nuevo proveedor con sus articulos
              if (posicion < 0) {
                //Indicamos la nueva posicion del nuevo proveedor
                //Restamos 1 posicion para ajustar a la posicion real dado que push devuelve el lenght
                posicion = compras.push({
                  nombre: producto.proveedor,
                  articulos: []
                }) - 1
              }

              //Agrega el nuevo articulo
              compras[posicion].articulos.push({
                cantidad: producto.cantidad,
                nombre: producto.nombre
              })

            })
          }
        })
        console.log(compras)
        this.set("compras", compras)
        this.set("cantidadCompras", compras.length)
      }


    }

    window.customElements.define(PolymerApp.is, PolymerApp);
  </script>
</dom-module>