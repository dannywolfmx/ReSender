<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/vaadin-tabs/vaadin-tabs.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">


<!-- Custom componnets -->

<link rel="import" href="./componentes/lista-articulos.html">
<link rel="import" href="./componentes/detalles-orden.html">
<link rel="import" href="./componentes/lista-correos.html">
<link rel="import" href="./componentes/lista-archivos.html">

<!-- Custom components estilo -->

<link rel="import" href="./estilo/estilo-botones.html">



<dom-module id="orden-de-compra">
    <template>
        <style include="estilo-botones">
            :host {
                display: block
            }

            paper-icon-button {
                width: 48px;
                height: 48px;
            }

            h1 {
                @apply --layout-flex;
                margin: 0;
                display: inline-block;
            }


            .listaCorreos {
                margin-top: 38px;
                margin-bottom: 38px;
                @apply --layout-vertical-reverse;
            }

            #lista {
                @apply --layout-horizontal;
                @apply --layout-around-justified;
                @apply --layout-wrap;
                display: none;
            }

            #status {
                margin: 20px 0px;
                @apply --layout-horizontal;
                @apply --layout-around-justified;
                padding: 12px;
                @apply --layout-center;
            }

            .barraEstatus:last-of-type {
                display: none !important;
            }

            .barraEstatus {
                transition: background 1s ease;
                content: '';
                background: var(--paper-blue-400);
                height: 3px;
                @apply --layout-flex;
                @apply --shadow-elevation-2dp;
            }

            .botonEstatus:first-child::before {
                content: none
            }


            .contenedorMultiOpciones {
                @apply --layout-horizontal;
                @apply --layout-end;
                padding: 18px;
            }

            .contenedorMultiOpciones>paper-input {
                @apply --layout-flex;
                --paper-input-container: {
                    padding: 0px;
                }
            }

            .seccionFormulario,
            .numeroOrdenDeCompra {
                padding: 26px;
                background: var(--paper-grey-50);
                border-top: 1px solid var(--paper-grey-200);
                border-bottom: 1px solid var(--paper-grey-200);
            }


            #icon {
                --timeu-wizard-step-font-family: FontAwesome;
            }




            #fileInput {
                display: none;
            }

            vaadin-form-layout.with-text-fields>vaadin-text-field {
                margin-top: .5em;
                margin-bottom: .5em;
            }

            vaadin-form-layout {
                padding: 26px 16px;
                background: var(--paper-grey-50);
                border-top: 1px solid var(--paper-grey-200);
                border-bottom: 1px solid var(--paper-grey-200);
                position: relative;
                margin-bottom: 12px;
            }

            #listaArchivos {
                @apply --layout-horizontal;
                @apply --layout-around-justified;
                @apply --layout-wrap;
                position: relative;
                padding: 20px;
            }

            #row {
                margin: 20px 0px;
            }

            #datosRow {
                @apply --layout-horizontal;
            }

            .elementosTabla {
                padding: 24px;
                width: 100%;
                @apply --layout-horizontal;
                @apply --layout-around-justified;
            }

            .column {
                font-size: var(--lumo-font-size-m);
                padding: var(--lumo-space-xs) var(--lumo-space-m);
                font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                line-height: var(--lumo-line-height-s);
                color: #212121;
                font-weight: bold;
            }

            .c2 {
                width: 15% !important;
            }

            .flexible {
                @apply --layout-flex;
            }

            .estatus {
                background: var(--paper-blue-600);
                color: var(--paper-grey-200);
                text-align: center;
                padding: 12px;
            }


            .botonEstatus {
                border-radius: 36px;
                width: 96px;
                height: 56px;
                background: white;
                color: var(--paper-blue-600);
                transition: color 1s ease;
                @apply --shadow-elevation-2dp;
            }

            .botonEstatus[pendiente] {
                color: var(--paper-grey-500) !important;
            }

            .barraEstatus[pendiente] {
                background: var(--paper-grey-400) !important;
            }

            #ordenCaja {
                max-width: 700px;
                margin: 0 auto;
                @apply --shadow-elevation-2dp;
                max-height: 0;
                transition: max-height 0.15s ease-out;
                overflow: auto;
            }

            #ordenCaja[mostrar] {
                max-height: 500px !important;
                transition: max-height 0.25s ease-in;
            }
        </style>

        <firebase-document id="query" app-name="bla" path="/ordenes/[[llaveOrden]]" data="{{ordenDeCompra}}">
        </firebase-document>
        <div id="row">
            <div id="datosRow"  on-click="mostrarDetalles">
                <div class="elementosTabla">
                    <div class="column flexible">[[orden.cliente]]</div>
                    <div class="column c2">[[orden.ordenDeCompra]]</div>
                    <div class="column c2">[[orden.factura]]</div>
                </div>
                <div class="column c2 estatus">[[orden.estatus]]</div>
            </div>


            <template is="dom-if" if="{{mostrarOrden}}">

                <div id="ordenCaja" on-drop="guardarArchivoDrag" mostrar$="[[mostrarOrdenAnimacion]]">
                    <vaadin-tabs selected="{{pagina}}">
                        <vaadin-tab>Datos orden</vaadin-tab>
                        <vaadin-tab>Lista articulos</vaadin-tab>
                        <vaadin-tab>Lista correos</vaadin-tab>
                        <vaadin-tab>Lista archivos</vaadin-tab>
                        <vaadin-tab>Default</vaadin-tab>
                    </vaadin-tabs>

                    <iron-pages selected="[[pagina]]">
                        <section>
                            <detalles-orden orden-de-compra="{{ordenDeCompra}}">
                                <paper-icon-button class="botonEliminar boton" icon="remove" on-tap="eliminarOrdenDeCompra"></paper-icon-button>
                            </detalles-orden>

                            <div id="status">
                                <template is="dom-repeat" items="[[listaTemplatesCorreos]]">
                                    <paper-icon-button icon="[[item.icon]]" on-click="fijaEstatus" class="botonEstatus" pendiente$="[[estiloBoton(index,ordenDeCompra.template)]]"></paper-icon-button>
                                    <div class="barraEstatus" pendiente$="[[estiloBoton(index,ordenDeCompra.template)]]"></div>
                                </template>
                            </div>

                            <vaadin-form-layout>
                                <vaadin-date-picker label="fecha de envio" placeholder="Placeholder" value="{{ordenDeCompra.fechaEnvio}}">
                                </vaadin-date-picker>

                                [[mensaje]]
                                <paper-icon-button class="botonEnviar boton" icon="send" on-tap="enviarCorreo"></paper-icon-button>
                            </vaadin-form-layout>
                        </section>


                        <!-- Lista de articulos ligados a una orden de compra -->
                        <lista-articulos productos="{{ordenDeCompra.productos}}"></lista-articulos>


                        <!-- Lista de correos ligados a una orden de compra -->
                        <lista-correos correos="{{ordenDeCompra.listaCorreos}}"></lista-correos>


                        <!-- Lista de archivos ligados a una orden de compra -->
                        <lista-archivos archivos="{{ordenDeCompra.listaArchivos}}"></lista-archivos>

                    </iron-pages>


                </div>
                <input type="file" id="fileInput" multiple>
            </template>
        </div>
    </template>

    <script>
        /**
         * `orden` Description
         *
         * @summary ShortDescription.
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
        class OrdenDeCompra extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'orden-de-compra';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    mostrarOrden: {
                        type: Boolean,
                        value: false
                    },
                    mostrarOrdenAnimacion: {
                        type: Boolean,
                        value: false
                    },
                    llaveOrden: {
                        type: String,
                        value: "",
                        notify: true
                    },
                    ordenDeCompra: {
                        type: Object,
                        value: {},
                        notify: true
                    },
                    listaTemplatesCorreos: {
                        type: Array,
                        value: [{
                                nombre: "Recepcion Pedido",
                                template: "recepcionPedido",
                                tipo: "recepcion",
                                icon: "maps:local-grocery-store"
                            },
                            {
                                nombre: "Programacion De Pedido",
                                template: "programacionDePedido",
                                tipo: "programacion",
                                icon: "icons:watch-later"
                            },
                            {
                                nombre: "Pedido enviado",
                                template: "pedidoEnviado",
                                tipo: "envio",
                                icon: "maps:local-shipping"
                            },
                            {
                                nombre: "Pedido entregado",
                                template: "pedidoEntregado",
                                tipo: "entrega",
                                icon: "maps:beenhere"
                            }
                        ]
                    },
                    ipcRenderer: {
                        type: Object
                    },
                    configuarionCorreo: {
                        type: Object,
                        value: {}
                    },
                    mensaje: {
                        type: String,
                        value: ""
                    },
                    ordenVisible: {
                        type: Boolean,
                        value: false
                    },
                    desactivarFireBase: {
                        type: Boolean,
                        value: true
                    }
                };
            }

            /**
             * Instance of the element is created/upgraded. Use: initializing state,
             * set up event listeners, create shadow dom.
             * @constructor
             */
            constructor() {
                super();
            }


            /**
             * Use for one-time configuration of your component after local DOM is initialized. 
             */
            ready() {
                super.ready();

                Polymer.RenderStatus.afterNextRender(this, function () {


                });
            }

            mostrarBotonAgregar(index, e) {
                return index !== (this.ordenDeCompra.listaCorreos.length - 1)
            }



            agregarProducto() {
                if (!this.ordenDeCompra.productos) {
                    this.set("ordenDeCompra.productos", {
                        0: {
                            nombre: "",
                            proveedor: ""
                        }
                    })
                } else {
                    let query = `ordenDeCompra.productos`
                    this.agregarElmementoArray(query, {
                        nombre: "",
                        proveedor: ""
                    })
                }
            }



            eliminarElementoArray(arrayOriginal, indice) {
                //Eliminar el indice indicado
                this.splice(arrayOriginal, indice, 1);
            }

            agregarArchivo(e) {
                this.$.fileInput.click()

                let self = this
                this.$.fileInput.onchange = function () {
                    Object.values(this.files).map(x => {

                        let archivo = {
                            "nombre": x.name,
                            "ruta": x.path
                        }
                        self.guardarArchivo(e, archivo)
                    })
                }
            }

            guardarArchivo(archivo) {
                archivo.oc = this.ordenDeCompra.ordenDeCompra

                this.ipcRenderer = this.ipcRenderer || require('electron').ipcRenderer
                this.ipcRenderer.send("copiarArchivo", archivo)

                let lista = `ordenDeCompra.listaArchivos`
                archivo.ruta = "OrdenesDeCompra\\" + archivo.oc + "\\" + archivo.nombre
                //Verificar si la lista esta inicializada
                if (!this.ordenDeCompra.listaArchivos) {
                    //Insertar el primer array de archivos
                    this.set(lista, [])
                }

                this.push(lista, archivo)
            }

            guardarArchivoDrag(e) {

                e.preventDefault();
                let archivos = e.dataTransfer.files

                Object.values(archivos).map(x => {

                    let archivo = {
                        "nombre": x.name,
                        "ruta": x.path
                    }
                    this.guardarArchivo(archivo)
                })


                // Pass event to removeDragData for cleanup
                this.removeDragData(e)
            }

            removeDragData(e) {


                if (e.dataTransfer.items) {
                    // Use DataTransferItemList interface to remove the drag data
                    e.dataTransfer.items.clear();
                } else {
                    // Use DataTransfer interface to remove the drag data
                    e.dataTransfer.clearData();
                }
            }

            eliminarArchivoDB(e) {
                let query = `ordenDeCompra.listaArchivos`
                this.eliminarElementoArray(query, e.model.index)
            }

            eliminarOrdenDeCompra() {
                //Eliminar con la api de firebird el elemento en base a la llave
                this.$.query.ref.remove();
                this.set("ordenDeCompra", {})
                this.set("llaveOrden", undefined)
            }

            normalisaArchivosParaCorreo(listaArchivos) {
                //Normalizar los correos para la forma del NodeMailer
                return listaArchivos.map(archivo => {
                    return {
                        "filename": archivo.nombre,
                        "path": archivo.ruta
                    }
                })
            }

            dameTemplateEstandar() {
                return {
                    "smtp": {
                        "service": this.configuarionCorreo.service,
                        "auth": {
                            "user": this.configuarionCorreo.user,
                            "pass": this.configuarionCorreo.pass
                        }
                    },
                    "send": {
                        "message": {
                            "from": this.configuarionCorreo.user,
                            "to": this.ordenDeCompra.listaCorreos
                        }
                    }
                }
            }

            esClienteActual(nombreParsial) {
                return this.ordenDeCompra.cliente.toUpperCase().includes(nombreParsial.toUpperCase())
            }

            agregaCorreoEspecial(cliente) {
                if (this.esClienteActual(cliente.nombre)) {
                    if (!this.ordenDeCompra.listaCorreos.includes(cliente.correo)) {
                        this.push("ordenDeCompra.listaCorreos", cliente.correo)
                    }
                }
            }

            entregaCorreosEspeciales() {
                return [{
                        nombre: "VECTRALIS",
                        correo: "invoice@vectralis.com"
                    }, {
                        nombre: "SIDEL",
                        correo: "invoice.ap@sidel.com"
                    }

                ]
            }


            dameTemplateEntrega(templateDelCorreo) {
                this.entregaCorreosEspeciales().map(x => this.agregaCorreoEspecial(x))
                //Correos especiales

                let template = this.dameTemplateEstandar()


                template.ordenDeCompra = this.ordenDeCompra

                if (this.esClienteActual("vectralis")) {
                    template.send.template = "pedidoEntregadoVectralis"
                } else if (this.esClienteActual("nature")) {
                    template.send.template = "pedidoEntregadoNature"
                } else {
                    template.send.template = templateDelCorreo
                }

                if (this.ordenDeCompra.listaArchivos) {
                    template.send.message.attachments = this.normalisaArchivosParaCorreo(this.ordenDeCompra.listaArchivos)
                }
                template.send.locals = {
                    "ordenDeCompra": this.ordenDeCompra.ordenDeCompra,
                    "numeroFactura": this.ordenDeCompra.factura,
                    "fechaEnvio": this.ordenDeCompra.fechaEnvio
                }


                return template
            }

            dameTemplateEnvio(templateDelCorreo) {
                let template = this.dameTemplateEstandar()

                template.ordenDeCompra = this.ordenDeCompra
                template.send.template = templateDelCorreo

                template.send.locals = {
                    "ordenDeCompra": this.ordenDeCompra.ordenDeCompra,
                    "fechaEnvio": this.ordenDeCompra.fechaEnvio
                }
                return template
            }

            dameTemplateProgramacion(templateDelCorreo) {
                let template = this.dameTemplateEstandar()

                template.ordenDeCompra = this.ordenDeCompra
                template.send.template = templateDelCorreo

                template.send.locals = {
                    "ordenDeCompra": this.ordenDeCompra.ordenDeCompra,
                    "fechaEnvio": this.ordenDeCompra.fechaEnvio
                }
                return template
            }

            dameTemplateRecepcion(templateDelCorreo) {

                let template = this.dameTemplateEstandar()

                template.ordenDeCompra = this.ordenDeCompra
                template.send.template = templateDelCorreo

                template.send.locals = {
                    "ordenDeCompra": this.ordenDeCompra.ordenDeCompra
                }
                return template
            }

            enviarCorreo(e) {
                let templateCorreo = {}
                let template = this.listaTemplatesCorreos[this.ordenDeCompra.template]

                switch (template.tipo) {
                    case "entrega":
                        templateCorreo = this.dameTemplateEntrega(template.template);
                        break;
                    case "envio":
                        templateCorreo = this.dameTemplateEnvio(template.template);
                        break;
                    case "programacion":
                        templateCorreo = this.dameTemplateProgramacion(template.template);
                        break;
                    case "recepcion":
                        templateCorreo = this.dameTemplateRecepcion(template.template);
                        break;
                    default:
                }

                let idTemplate = this.ordenDeCompra.template

                this.ipcRenderer = this.ipcRenderer || require('electron').ipcRenderer

                this.ipcRenderer.send("enviarCorreo", templateCorreo)

                this.ipcRenderer.on("respuestaEnvioCorreo", function (e, arg) {
                    if (arg) {
                        this.set("mensaje", "Correo enviado")
                    } else {
                        this.set("mensaje", "Error al enviar mensaje")
                    }
                }.bind(this))

            }

            fijaEstatus(e) {
                this.set("ordenDeCompra.template", e.model.index)
                this.set("ordenDeCompra.estatus", e.model.item.tipo)
            }
            estiloBoton(e, b) {
                return e > this.ordenDeCompra.template
            }

            mostrarDetalles(e) {
                if (this.mostrarOrden) {
                    //Ocultar orden cuando este ya se este mostrando
                    this.ocultarOrdenFunc()
                } else {
                    //Mostrar orden cuando esta no se este mostrando
                    this.mostrarOrdenFunc()
                }


                if (this.mostrarOrden) {
                    this.set("llaveOrden", undefined)
                    this.set("llaveOrden", this.orden.$key)
                }
            }

            mostrarOrdenFunc() {
                this.set("mostrarOrden", true)


                setTimeout(() => {
                    this.set("mostrarOrdenAnimacion", true)
                }, 1)
            }

            ocultarOrdenFunc() {
                this.set("mostrarOrdenAnimacion", false)
                setTimeout(() => {
                    this.set("mostrarOrden", false)
                }, 250)
            }
        }

        window.customElements.define(OrdenDeCompra.is, OrdenDeCompra);
    </script>
</dom-module>