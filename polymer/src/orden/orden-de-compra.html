<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<dom-module id="orden-de-compra">
    <template>
        <style>
            :host {
                display: block
            }

            paper-icon-button {
                width: 48px;
                height: 48px;
            }

            h1 {
                @apply --layout-flex;
                margin: 0;
                display: inline-block;
            }

            .cabecera>* {
                margin-left: 16px;
            }

            .cabecera {
                @apply --layout-horizontal;
                @apply --layout-center;
                color: #55564F;
                padding-top: 10px;
                padding-bottom: 10px;
                margin: 0px;
                font-family: sans-serif;
            }

            .listaCorreos {
                margin-top: 38px;
                margin-bottom: 38px;
                @apply --layout-vertical-reverse;
            }

            #lista {
                @apply --layout-horizontal;
                @apply --layout-around-justified;
                @apply --layout-wrap;
                display: none;
            }

            #status {
                margin: 20px 0px;
                @apply --layout-horizontal;
                @apply --layout-around-justified;
                padding: 12px;
                @apply --layout-center;
            }

            .barraEstatus:last-of-type {
                display: none !important;
            }

            .botonEstatus {
                border-radius: 36px;
                width: 96px;
                height: 56px;
                background: white;
                color: var(--paper-blue-600);
                transition: color 1s ease;
                @apply --shadow-elevation-2dp;
            }

            .botonEstatus[pendiente] {
                color: var(--paper-grey-500) !important;
            }

            .barraEstatus[pendiente] {
                background: var(--paper-grey-400) !important;
            }

            .barraEstatus {
                transition: background 1s ease;
                content: '';
                background: var(--paper-blue-400);
                height: 3px;
                @apply --layout-flex;
                @apply --shadow-elevation-2dp;
            }

            .botonEstatus:first-child::before {
                content: none
            }


            .contenedorMultiOpciones {
                @apply --layout-horizontal;
                @apply --layout-end;
                padding: 18px;
            }

            .contenedorMultiOpciones>paper-input {
                @apply --layout-flex;
                --paper-input-container: {
                    padding: 0px;
                }
            }

            .botonAgregar {
                color: white;
            }

            .botonAgregar {
                background: var(--paper-blue-300);
            }

            .botonRemover {
                color: var(--paper-red-300);
            }

            .seccionFormulario,
            .numeroOrdenDeCompra {
                padding: 26px;
                background: var(--paper-grey-50);
                border-top: 1px solid var(--paper-grey-200);
                border-bottom: 1px solid var(--paper-grey-200);
            }


            #icon {
                --timeu-wizard-step-font-family: FontAwesome;
            }

            .archivos {
                @apply --layout-horizontal;
                @apply --layout-around-justified;
                @apply --layout-wrap;
                padding: 26px;
                background: var(--paper-grey-50);
                border-top: 1px solid var(--paper-grey-200);
                border-bottom: 1px solid var(--paper-grey-200);
            }

            .archivo {
                height: 64px;
                margin: 16px;
                border-radius: 8px;
                position: relative;
                @apply --shadow-elevation-2dp;
            }

            .archivo {
                background: white;
                padding: 12px;
                width: 200px;
                word-break: break-all;
                text-align: center;
            }

            .agregarArchivo {
                background: var(--paper-blue-400);
            }

            .boton {
                color: white;
                height: 48px !important;
                width: 48px !important;
                position: absolute;
                top: 0;
                right: 0;
                @apply --shadow-elevation-4dp;
            }

            .botonEliminar {
                background: var(--paper-red-300);
            }

            .botonEnviar {
                background: var(--paper-blue-300);
            }


            #fileInput {
                display: none;
            }

            vaadin-form-layout.with-text-fields>vaadin-text-field {
                margin-top: .5em;
                margin-bottom: .5em;
            }

            vaadin-form-layout {
                padding: 26px 16px;
                background: var(--paper-grey-50);
                border-top: 1px solid var(--paper-grey-200);
                border-bottom: 1px solid var(--paper-grey-200);
                position: relative;
                margin-bottom: 12px;
            }

            #listaArchivos {
                @apply --layout-horizontal;
                @apply --layout-around-justified;
                @apply --layout-wrap;
                position: relative;
                padding: 20px;
            }
        </style>

        <firebase-document id="query" app-name="bla" path="/ordenes/[[llaveOrden]]" data="{{ordenDeCompra}}">
        </firebase-document>



        <div id="ordenCaja" on-drop="guardarArchivoDrag">
            <vaadin-form-layout>
                <vaadin-text-field label="Orden de compra" value="{{ordenDeCompra.ordenDeCompra}}"></vaadin-text-field>
                <vaadin-text-field label="Factura" value="{{ordenDeCompra.factura}}"></vaadin-text-field>
                <vaadin-text-field colspan="2" label="Nombre cliente" value="{{ordenDeCompra.cliente}}"></vaadin-text-field>
                <paper-icon-button class="botonEliminar boton" icon="remove" on-tap="eliminarOrdenDeCompra"></paper-icon-button>
            </vaadin-form-layout>

            <vaadin-form-layout>
                <template is="dom-repeat" items="{{ordenDeCompra.listaCorreos}}" as="correo">
                    <vaadin-text-field label="Direccion de correo" value="{{correo}}">
                        <paper-icon-button slot="suffix" class="botonRemover" icon="remove" on-tap="eliminarCorreo"></paper-icon-button>
                    </vaadin-text-field>
                </template>
                <paper-icon-button class="botonAgregar boton" icon="add" on-tap="agregarCorreo"></paper-icon-button>
            </vaadin-form-layout>



            <div id="status">

                <template is="dom-repeat" items="[[listaTemplatesCorreos]]">
                    <paper-icon-button icon="[[item.icon]]" on-click="fijaEstatus" class="botonEstatus" pendiente$="[[estiloBoton(index,ordenDeCompra.template)]]"></paper-icon-button>
                    <div class="barraEstatus" pendiente$="[[estiloBoton(index,ordenDeCompra.template)]]"></div>
                </template>

            </div>
            <div>
                <vaadin-date-picker label="fecha de envio" placeholder="Placeholder" value="{{ordenDeCompra.fechaEnvio}}">
                </vaadin-date-picker>
            </div>

            <div id="listaArchivos">
                <template is="dom-repeat" items="{{ordenDeCompra.listaArchivos}}" as="archivo">
                    <div class="archivo">
                        [[archivo.nombre]]
                        <paper-icon-button class="botonEliminar" icon="remove" on-tap="eliminarArchivoDB" data-item$="[[ordenDeCompra.listaArchivos]]"></paper-icon-button>
                    </div>
                </template>

                <paper-icon-button class="agregarArchivo boton" on-tap="agregarArchivo" icon="add"></paper-icon-button>
            </div>

            <vaadin-form-layout>

                [[mensaje]]
                <paper-icon-button class="botonEnviar boton" icon="send" on-tap="enviarCorreo"></paper-icon-button>
            </vaadin-form-layout>

        </div>
        <input type="file" id="fileInput" multiple>
    </template>

    <script>
        /**
         * `orden` Description
         *
         * @summary ShortDescription.
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
        class OrdenDeCompra extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'orden-de-compra';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    llaveOrden: {
                        type: String,
                        value: "",
                        notify: true
                    },
                    ordenDeCompra: {
                        type: Object,
                        value: {},
                        notify: true
                    },
                    listaTemplatesCorreos: {
                        type: Array,
                        value: [{
                                nombre: "Recepcion Pedido",
                                template: "recepcionPedido",
                                tipo: "recepcion",
                                icon: "maps:local-grocery-store"
                            },
                            {
                                nombre: "Programacion De Pedido",
                                template: "programacionDePedido",
                                tipo: "programacion",
                                icon: "icons:watch-later"
                            },
                            {
                                nombre: "Pedido enviado",
                                template: "pedidoEnviado",
                                tipo: "envio",
                                icon: "maps:local-shipping"
                            },
                            {
                                nombre: "Pedido entregado",
                                template: "pedidoEntregado",
                                tipo: "entrega",
                                icon: "maps:beenhere"
                            }
                        ]
                    },
                    ipcRenderer: {
                        type: Object,
                        value: {}
                    },
                    configuarionCorreo: {
                        type: Object,
                        value: {}
                    },
                    mensaje: {
                        type: String,
                        value: ""
                    },
                    ordenVisible: {
                        type: Boolean,
                        value: false
                    },
                    desactivarFireBase: {
                        type: Boolean,
                        value: true
                    }
                };
            }

            /**
             * Instance of the element is created/upgraded. Use: initializing state,
             * set up event listeners, create shadow dom.
             * @constructor
             */
            constructor() {
                super();
            }


            /**
             * Use for one-time configuration of your component after local DOM is initialized. 
             */
            ready() {
                super.ready();

                Polymer.RenderStatus.afterNextRender(this, function () {
                    this.ipcRenderer = require('electron').ipcRenderer

                    this.ipcRenderer.on("respuestaEnvioCorreo", function (e, arg) {
                        if (arg) {
                            this.set("mensaje", "Correo enviado")
                        } else {
                            this.set("mensaje", "Error al enviar mensaje")
                        }
                    }.bind(this))
                });
            }

            mostrarBotonAgregar(index, e) {
                return index !== (this.ordenDeCompra.listaCorreos.length - 1)
            }

            agregarCorreo(e) {
                let query = `ordenDeCompra.listaCorreos`
                this.agregarElmementoArray(query)
            }

            eliminarCorreo(e) {
                let query = `ordenDeCompra.listaCorreos`
                this.eliminarElementoArray(query, e.model.index)
            }
            eliminarElementoArray(arrayOriginal, indice) {
                //Eliminar el indice indicado
                this.splice(arrayOriginal, indice, 1);
            }

            agregarElmementoArray(arrayOriginal) {
                //Agregar elemento vacio en la lista
                this.push(arrayOriginal, "")
            }

            agregarArchivo(e) {
                this.$.fileInput.click()

                let self = this
                this.$.fileInput.onchange = function () {
                    Object.values(this.files).map(x => {

                        let archivo = {
                            "nombre": x.name,
                            "ruta": x.path
                        }
                        self.guardarArchivo(e, archivo)
                    })
                }
            }

            guardarArchivo(archivo) {
                archivo.oc = this.ordenDeCompra.ordenDeCompra

                this.ipcRenderer = this.ipcRenderer || require('electron').ipcRenderer
                this.ipcRenderer.send("copiarArchivo", archivo)

                let lista = `ordenDeCompra.listaArchivos`
                archivo.ruta = "OrdenesDeCompra\\" + archivo.oc + "\\" + archivo.nombre
                //Verificar si la lista esta inicializada
                if (!this.ordenDeCompra.listaArchivos) {
                    //Insertar el primer array de archivos
                    this.set(lista, [])
                }

                this.push(lista, archivo)
            }

            guardarArchivoDrag(e) {

                e.preventDefault();
                let archivos = e.dataTransfer.files

                Object.values(archivos).map(x => {

                    let archivo = {
                        "nombre": x.name,
                        "ruta": x.path
                    }
                    this.guardarArchivo(archivo)
                })


                // Pass event to removeDragData for cleanup
                this.removeDragData(e)
            }

            removeDragData(e) {


                if (e.dataTransfer.items) {
                    // Use DataTransferItemList interface to remove the drag data
                    e.dataTransfer.items.clear();
                } else {
                    // Use DataTransfer interface to remove the drag data
                    e.dataTransfer.clearData();
                }
            }

            eliminarArchivoDB(e) {
                let query = `ordenDeCompra.listaArchivos`
                this.eliminarElementoArray(query, e.model.index)
            }

            eliminarOrdenDeCompra() {
                //Eliminar con la api de firebird el elemento en base a la llave
                this.$.query.ref.remove();
                this.set("ordenDeCompra", {})
                this.set("llaveOrden", undefined)
            }

            normalisaArchivosParaCorreo(listaArchivos) {
                //Normalizar los correos para la forma del NodeMailer
                return listaArchivos.map(archivo => {
                    return {
                        "filename": archivo.nombre,
                        "path": archivo.ruta
                    }
                })
            }

            dameTemplateEstandar() {
                return {
                    "smtp": {
                        "service": this.configuarionCorreo.service,
                        "auth": {
                            "user": this.configuarionCorreo.user,
                            "pass": this.configuarionCorreo.pass
                        }
                    },
                    "send": {
                        "message": {
                            "from": this.configuarionCorreo.user,
                            "to": this.ordenDeCompra.listaCorreos
                        }
                    }
                }
            }

            esClienteActual(nombreParsial) {
                return this.ordenDeCompra.cliente.toUpperCase().includes(nombreParsial.toUpperCase())
            }

            agregaCorreoEspecial(cliente) {
                if (this.esClienteActual(cliente.nombre)) {
                    if (!this.ordenDeCompra.listaCorreos.includes(cliente.correo)) {
                        this.push("ordenDeCompra.listaCorreos", cliente.correo)
                    }
                }
            }

            entregaCorreosEspeciales() {
                return [{
                        nombre: "VECTRALIS",
                        correo: "invoice@vectralis.com"
                    }, {
                        nombre: "SIDEL",
                        correo: "invoice.ap@sidel.com"
                    }

                ]
            }


            dameTemplateEntrega(templateDelCorreo) {
                this.entregaCorreosEspeciales().map(x => this.agregaCorreoEspecial(x))
                //Correos especiales

                let template = this.dameTemplateEstandar()


                template.ordenDeCompra = this.ordenDeCompra

                if (this.esClienteActual("vectralis")) {
                    template.send.template = "pedidoEntregadoVectralis"
                } else if (this.esClienteActual("nature")) {
                    template.send.template = "pedidoEntregadoNature"
                } else {
                    template.send.template = templateDelCorreo
                }

                if (this.ordenDeCompra.listaArchivos) {
                    template.send.message.attachments = this.normalisaArchivosParaCorreo(this.ordenDeCompra.listaArchivos)
                }
                template.send.locals = {
                    "ordenDeCompra": this.ordenDeCompra.ordenDeCompra,
                    "numeroFactura": this.ordenDeCompra.factura,
                    "fechaEnvio": this.ordenDeCompra.fechaEnvio
                }


                return template
            }

            dameTemplateEnvio(templateDelCorreo) {
                let template = this.dameTemplateEstandar()

                template.ordenDeCompra = this.ordenDeCompra
                template.send.template = templateDelCorreo

                template.send.locals = {
                    "ordenDeCompra": this.ordenDeCompra.ordenDeCompra,
                    "fechaEnvio": this.ordenDeCompra.fechaEnvio
                }
                return template
            }

            dameTemplateProgramacion(templateDelCorreo) {
                let template = this.dameTemplateEstandar()

                template.ordenDeCompra = this.ordenDeCompra
                template.send.template = templateDelCorreo

                template.send.locals = {
                    "ordenDeCompra": this.ordenDeCompra.ordenDeCompra,
                    "fechaEnvio": this.ordenDeCompra.fechaEnvio
                }
                return template
            }

            dameTemplateRecepcion(templateDelCorreo) {

                let template = this.dameTemplateEstandar()

                template.ordenDeCompra = this.ordenDeCompra
                template.send.template = templateDelCorreo

                template.send.locals = {
                    "ordenDeCompra": this.ordenDeCompra.ordenDeCompra
                }
                return template
            }

            enviarCorreo(e) {
                let templateCorreo = {}
                let template = this.listaTemplatesCorreos[this.ordenDeCompra.template]

                switch (template.tipo) {
                    case "entrega":
                        templateCorreo = this.dameTemplateEntrega(template.template);
                        break;
                    case "envio":
                        templateCorreo = this.dameTemplateEnvio(template.template);
                        break;
                    case "programacion":
                        templateCorreo = this.dameTemplateProgramacion(template.template);
                        break;
                    case "recepcion":
                        templateCorreo = this.dameTemplateRecepcion(template.template);
                        break;
                    default:
                }
                console.log(templateCorreo)
                let idTemplate = this.ordenDeCompra.template
                this.ipcRenderer.send("enviarCorreo", templateCorreo)
            }

            fijaEstatus(e) {
                this.set("ordenDeCompra.template", e.model.index)
                this.set("ordenDeCompra.estatus", e.model.item.tipo)
            }
            estiloBoton(e, b) {
                return e > this.ordenDeCompra.template
            }
        }

        window.customElements.define(OrdenDeCompra.is, OrdenDeCompra);
    </script>
</dom-module>